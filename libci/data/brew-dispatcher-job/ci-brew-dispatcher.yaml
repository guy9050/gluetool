---

- job:
    name: 'ci-brew-dispatcher'
    description: |
        Runs generic brew dispatcher. Note that the 'brew-dispatcher' module
        reads all required variables (name, version, release, target and task_id)
        from the environment.
    concurrent: true
    display-name: 'ci-brew-dispatcher'
    parameters:
      - string:
          name: id
          description: 'Brew task ID'
      - string:
          name: name
          description: 'Package name'
      - string:
          name: version
          description: 'Package version'
      - string:
          name: release
          description: 'Package release'
      - string:
          name: target
          description: 'Brew target'
    triggers:
      - ci-trigger:
          jms-selector: |
            CI_TYPE = 'brew-taskstatechange'
            AND method = 'build'
            AND new = 'CLOSED'
    wrappers:
      - ansicolor:
          colormap: xterm
      - workspace-cleanup
    builders:
      - shell: |
          citool -c -i -o citool-debug.txt envinject jenkins brew --id $id brew-build-name brew-dispatcher
      - inject:
          properties-file: envinject-citool.props
    publishers:
      - archive:
          artifacts: '**/**'
          allow-empty: 'true'
