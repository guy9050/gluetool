---
- job:
    name: 'ci-koji-dispatcher'
    node: dispatcher
    description: |
        Runs generic koji dispatcher for dispatching testing for builds built via Fedora's koji build system.
    concurrent: true
    display-name: 'ci-koji-dispatcher'
    parameters:
      - string:
          name: task_id
          description: 'Koji task ID'
      - string:
          name: pipeline_state_reporter_options
          default: ''
          description: 'Additional options for pipeline-state-reporter module.'
    triggers:
      - ci-trigger:
          jms-selector: >
            CI_TYPE = 'fedmsg' AND new = 1 AND original_topic = 'org.fedoraproject.prod.buildsys.build.state.change'
    wrappers:
      - ansicolor:
          colormap: xterm
      - workspace-cleanup
    builders:
      - shell:
          citool -c -i -o citool-debug.txt
                 koji --task-id $task_id --wait 3600
                 testing-thread
                 jenkins
                 brew-build-name
                 publisher-umb-bus
                 pipeline-state-reporter --category=dispatcher ${pipeline_state_reporter_options}
                 test-batch-planner --methods=static-config --config=${CITOOL_CONFIG}/koji-dispatcher.yaml
                 koji-dispatcher
    properties:
      - build-discarder:
          num-to-keep: 500
    publishers:
      - archive:
          artifacts: '**/**'
          allow-empty: 'true'
