---
- job:
    name: 'build-on-commit'
    node: boc
    description: |
        Schedule scratch build after push into staging branch of any dist-git repository.
    concurrent: true
    display-name: 'ci-build-on-commit'
    parameters:
      - string:
          name: repo
          description: 'Component name'
      - string:
          name: branch
          description: 'Git branch'
      - string:
          name: username
          description: 'Name of the user to notify'
      - string:
          name: pipeline_state_reporter_options
          default: ''
          description: 'Additional options for pipeline-state-reporter module.'
    triggers:
      - ci-trigger:
          jms-selector: >
            type = 'dist-git' AND namespace = 'rpms' AND branch LIKE '%staging%'
    wrappers:
      - ansicolor:
          colormap: xterm
      - workspace-cleanup
    builders:
      - shell:
          # ${username} is set in the environment by the Red Hat CI plugin
          citool -c -i -o citool-debug.txt
                 notify-recipients --boc-add-notify ${username}
                 publisher-umb-bus
                 pipeline-state-reporter --dont-report-started --category=boc ${pipeline_state_reporter_options}
                 jenkins
                 build-on-commit --component ${repo} --branch ${branch}
                 notify-email
    properties:
      - build-discarder:
          num-to-keep: 500
    publishers:
      - archive:
          artifacts: 'citool-debug.txt'
          allow-empty: 'true'
