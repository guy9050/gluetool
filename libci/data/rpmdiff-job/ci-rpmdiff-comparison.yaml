---

- job:
    name: 'ci-rpmdiff-comparison'
    node: rpmdiff
    description: |
        RPMdiff comparison job

        Runs RPMdiff comparison of given brew task against latest released package.
    concurrent: true
    display-name: 'ci-rpmdiff-comparison'
    parameters:
      - string:
          name: id
          default: ''
          description: 'Brew task ID.'
      - string:
          name: pipeline_prepend
          default: ''
          description: 'citool options that will be added at the beginning of citool pipeline'
      - string:
          name: pipeline_append
          default: ''
          description: 'citool options that will be added at the end of citool pipeline'
      - string:
          name: notify_recipients_options
          default: ''
          description: 'Additional options for notify-recipients module.'
      - string:
          name: notify_email_options
          default: ''
          description: 'Additional options for notify-email module.'
    wrappers:
      - ansicolor:
          colormap: xterm
      - workspace-cleanup
    builders:
      - shell:
          citool -c -i -o citool-debug.txt
                 ${pipeline_prepend}
                 notify-recipients ${notify_recipients_options}
                 jenkins
                 testing-results
                 brew --id $id
                 brew-build-name
                 rpmdiff --type comparison
                 postgresql
                 rpmdiff-waiver
                 make-bus-messages
                 publisher-ci-bus
                 notify-email ${notify_email_options}
                 ${pipeline_append}
    properties:
      - build-discarder:
          num-to-keep: 500
    publishers:
      - archive:
          artifacts: '**/**'
          allow-empty: 'true'
      - groovy-postbuild:
          on-failure: "failed"
          script: |
              if (manager.getResult() == "SUCCESS") {
                  manager.listener.logger.println("[groovy-postbuild]: Success - cheching result of testing process");
                  manager.addBadge("success.gif", "CI pipeline finished successfully");
                  manager.createSummary("green.gif").appendText("<h1>CI pipeline finished successfully</h1>",
                                                                false, false, false, "green");

                  if (manager.logContains(".*result: Failed.*")) {
                      manager.listener.logger.println("[groovy-postbuild]: Tests failed");
                      manager.addBadge("delete.gif", "Tests FAILED");
                      manager.createSummary("red.gif").appendText("<h1>Tests failed</h1>",
                                                                  false, false, false, "red");

                  } else if (manager.logContains(".*result: Needs inspection.*")) {
                      manager.listener.logger.println("[groovy-postbuild]: Tests failed with needs inspection");
                      manager.addBadge("delete.gif", "Tests FAILED");
                      manager.createSummary("red.gif").appendText("<h1>Tests failed with needs inspection</h1>",
                                                                  false, false, false, "red");

                  } else if (manager.logContains(".*result: (Passed|Info).*")) {
                      manager.listener.logger.println("[groovy-postbuild]: Tests passed");
                      manager.addBadge("success.gif", "Tests PASSED");
                      manager.createSummary("green.gif").appendText("<h1>Tests passed</h1>",
                                                                    false, false, false, "green");

                  } else if (manager.logContains(".*skipping blacklisted package.*")) {
                      manager.listener.logger.println("[groovy-postbuild]: Skippped testing because package " +
                                                      " blacklisted");
                      manager.addBadge("info.gif", "Testing skipped - blacklisted package");
                      manager.createSummary("grey.gif").appendText("<h1>Testing skipped</h1>",
                                                                   false, false, false, "grey");
                  } else {
                      manager.listener.logger.println("[groovy-postbuild]: Cannot find result of the testing process");
                      manager.addBadge("warning.gif", "Tests result unknown");
                      manager.addShortText("UNKNOWN");
                      manager.createSummary("red.gif").appendText("<h1>Tests results are unknown</h1>",
                                                                  false, false, false, "red");
                  }
              } else {
                  manager.listener.logger.println("[groovy-postbuild]: Failure - giving up on result search");
                  manager.addBadge("error.gif", "CI pipeline crashed");
                  manager.createSummary("red.gif").appendText("<h1>CI pipeline failed to finish</h1>",
                                                              false, false, false, "red");
                  if (manager.logContains(".*could not find baseline for this build.*")) {
                      manager.listener.logger.println("[groovy-postbuild]: Skippped testing because baseline" +
                                                      " build not found in Brew");
                      manager.addBadge("info.gif", "Testing skipped - no baseline build found in Brew");
                      manager.createSummary("grey.gif").appendText("<h1>Testing skipped</h1>",
                                                                   false, false, false, "grey");
                  } else {
                      manager.addBadge("error.gif", "Tests did not run correctly");
                      manager.createSummary("red.gif").appendText("<h1>Tests did not run correctly</h1>",
                                                                  false, false, false, "red");
                  }
              }
