---

name: beaker
description: Runs tests on Beaker boxes.
dependencies:
  repo:
    - name: beaker-client
      description: Beaker client repository
      baseurl: http://download-node-02.eng.bos.redhat.com/beakerrepos/client/Fedora29
      exclude: kobo kobo-rpmlib kobo-client
    - name: beaker-harness
      description: Beaker harness repository
      baseurl: http://beaker.engineering.redhat.com/harness/Fedora29
      exclude: "rhts-* restraint-rhts"

    # for qa-tools-workstation
    - name: qa-tools
      description: qa-tools repository
      baseurl: http://liver.brq.redhat.com/repo-testing/

  yum:
    - beaker-client
    - beaker-redhat
    - qa-tools-workstation

  pip:
    - beautifulsoup4==4.6.3
    - git+https://github.com/psss/python-nitrate.git@1.3-2#egg=nitrate
    - python-dateutil==2.6.1

  ansible_tasks:
    - name: "Requires: pykickstart because of qa-tools-workstation"
      lineinfile:
        dest: "{{ SPECFILE }}"
        regexp: "^Requires: /usr/lib/python2.7/site-packages/pykickstart"
        line: "# added by 'beaker' module\nRequires: /usr/lib/python2.7/site-packages/pykickstart\n"
        state: present
        insertbefore: "^# TASK: GLOBAL-BEFORE-DESCRIPTION"
      when: BUILDING_SPECFILE is defined

    - name: "Requires: krb5-devel because of krb5.h"
      lineinfile:
        dest: "{{ SPECFILE }}"
        regexp: "^Requires: krb5-devel"
        line: "# added by 'beaker' module\nRequires: krb5-devel\n"
        state: present
        insertbefore: "^# TASK: GLOBAL-BEFORE-DESCRIPTION"
      when: BUILDING_SPECFILE is defined

    - name: "BuildRequires: krb5-devel because of krb5.h"
      lineinfile:
        dest: "{{ SPECFILE }}"
        regexp: "^BuildRequires: krb5-devel"
        line: "# added by 'beaker' module\nBuildRequires: krb5-devel\n"
        state: present
        insertbefore: "^# TASK: GLOBAL-BEFORE-DESCRIPTION"
      when: BUILDING_SPECFILE is defined

    # 'beaker' module imports tcms-results which needs qe.py
    - name: "%post: inject system qe.py package into virtualenv"
      lineinfile:
        dest: "{{ SPECFILE }}"
        regexp: "^ln -s /usr/share/qa-tools/python-modules/qe\\.py %GLUETOOL_BASE/lib/python2\\.7/site-packages/qe\\.py"
        line: "# added by 'beaker' module\nln -s /usr/share/qa-tools/python-modules/qe.py %GLUETOOL_BASE/lib/python2.7/site-packages/qe.py\n"
        state: present
        insertafter: "^# TASK: POST-START"
      when: BUILDING_SPECFILE is defined
