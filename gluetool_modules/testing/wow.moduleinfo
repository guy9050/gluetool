---

name: wow
description: "Uses workflow-tomorrow to create beaker job XML description."
dependencies:
  repo:
    - name: beaker-client
      description: Beaker client repository
      baseurl: http://download-node-02.eng.bos.redhat.com/beakerrepos/client/Fedora$releasever
      exclude: kobo kobo-rpmlib kobo-client
    - name: beaker-harness
      description: Beaker harness repository
      baseurl: http://beaker.engineering.redhat.com/harness/Fedora$releasever
      exclude: "rhts-* restraint-rhts"
    # for qa-tools-workstation
    - name: qa-tools
      description: qa-tools repository
      baseurl: http://coprbe.devel.redhat.com/results/lpol/qa-tools/fedora-$releasever-$basearch/

  pip:
    # both required by qe.py
    - git+https://github.com/psss/python-nitrate.git@1.3-2#egg=nitrate
    - python-dateutil==2.6.1

  yum:
    # because the module uses qe.py to discover test plans from TCMS
    - beaker-client
    - beaker-redhat
    - qa-tools-workstation-qa-tools
    - qa-tools-workstation-integration_scripts
    - qa-tools-workstation-mpetlan

  ansible_tasks:
    - name: "Requires: krb5-devel because of krb5.h"
      lineinfile:
        dest: "{{ SPECFILE }}"
        regexp: "^Requires: krb5-devel"
        line: "# added by 'wow' module\nRequires: krb5-devel\n"
        state: present
        insertbefore: "^# TASK: GLOBAL-BEFORE-DESCRIPTION"
      when: BUILDING_SPECFILE is defined

    - name: "BuildRequires: krb5-devel because of krb5.h"
      lineinfile:
        dest: "{{ SPECFILE }}"
        regexp: "^BuildRequires: krb5-devel"
        line: "# added by 'wow' module\nBuildRequires: krb5-devel\n"
        state: present
        insertbefore: "^# TASK: GLOBAL-BEFORE-DESCRIPTION"
      when: BUILDING_SPECFILE is defined

    - name: "%post: inject python3 system qe.py package into virtualenv"
      lineinfile:
        dest: "{{ SPECFILE }}"
        regexp: "^ln -s /usr/lib/python3\\.7/site-packages/qe\\.py %GLUETOOL_BASE/lib/python2\\.7/site-packages/qe\\.py"
        line: "# added by 'wow' module\nln -s /usr/lib/python3.7/site-packages/qe.py %GLUETOOL_BASE/lib/python2.7/site-packages/qe.py\n"
        state: present
        insertafter: "^# TASK: POST-START"
      when: BUILDING_SPECFILE is defined

    - name: "%post: inject python3 system qe.py into python2 system paths"
      lineinfile:
        dest: "{{ SPECFILE }}"
        regexp: "^ln -s /usr/lib/python3\\.7/site-packages/qe\\.py /usr/lib/python2\\.7/site-packages/qe\\.py"
        line: "# added by 'wow' module\nln -s /usr/lib/python3.7/site-packages/qe.py /usr/lib/python2.7/site-packages/qe.py\n"
        state: present
        insertafter: "^ln -s /usr/lib/python3\\.7/site-packages/qe\\.py %GLUETOOL_BASE/lib/python2\\.7/site-packages/qe\\.py"
      when: BUILDING_SPECFILE is defined

    # bundle sclrun with wow
    - name: Clone RHSCL Apps tools repository
      lineinfile:
        dest: "{{ DOCKERFILE }}"
        regexp: "^# added by 'wow module$"
        line: |
          # added by 'wow' module
          RUN git clone git://git.host.prod.eng.bos.redhat.com/RH_Software_Collections /usr/local/sclrun
          RUN ln -s /usr/local/sclrun/Scripts/schedulator/sclrun /usr/bin/sclrun
        state: present
        insertafter: "^# TASK: POST-START"
      when: BUILDING_DOCKERFILE is defined
